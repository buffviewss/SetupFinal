#!/bin/bash
set -e

# === Ki·ªÉm tra v√† c√†i python3-venv n·∫øu c·∫ßn ===
if ! dpkg -l | grep -q "python3.12-venv"; then
    if ! dpkg -l | grep -q "python3-venv"; then
        echo "üì¶ ƒêang c√†i python3-venv..."
        sudo apt update
        sudo apt install -y python3-venv
    fi
fi

# === T·∫°o Python venv + c√†i gdown ===
if [[ ! -d "$HOME/gdown-venv" ]]; then
    echo "üì¶ T·∫°o venv v√† c√†i gdown..."
    python3 -m venv ~/gdown-venv
fi
source ~/gdown-venv/bin/activate
if ! command -v pip &>/dev/null; then
    echo "‚ö†Ô∏è C√†i pip cho venv..."
    python3 -m ensurepip --upgrade || sudo apt install -y python3-pip
fi
pip install --upgrade --no-cache-dir gdown

# === CH·ªåN TR√åNH DUY·ªÜT C√ÄI ===
CHROME_ID="1tD0XPj-t5C7p9ByV3RLg-qcHaYYSXAj1"
FIREFOX_ID="1CeMNJTLgfsaFkcroOh1xpxFC-uz9HrLb"
DOWNLOAD_DIR="$HOME/browser_temp"
mkdir -p "$DOWNLOAD_DIR" && cd "$DOWNLOAD_DIR"

echo "Ch·ªçn tr√¨nh duy·ªát mu·ªën c√†i:"
select browser in "Chrome" "Firefox" "Tho√°t"; do
    case $browser in
        Chrome) DRIVE_ID="$CHROME_ID"; BTYPE="chrome"; break;;
        Firefox) DRIVE_ID="$FIREFOX_ID"; BTYPE="firefox"; break;;
        Tho√°t) exit 0;;
        *) echo "‚ùå L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!";;
    esac
done

echo "üì• T·∫£i $BTYPE t·ª´ Google Drive..."
gdown --folder "https://drive.google.com/drive/folders/$DRIVE_ID" --no-cookies

echo "üîç Ch·ªçn file ƒë·ªÉ c√†i:"
mapfile -t FILE_LIST < <(find "$DOWNLOAD_DIR" -type f)
for i in "${!FILE_LIST[@]}"; do
    echo "$((i+1)). ${FILE_LIST[i]}"
done
read -p "üëâ Nh·∫≠p s·ªë th·ª© t·ª±: " choice
FILE_SELECT="${FILE_LIST[choice-1]}"

echo "üßπ D·ªçn file kh√¥ng d√πng..."
find "$DOWNLOAD_DIR" -type f ! -name "$(basename "$FILE_SELECT")" -delete

echo "üóëÔ∏è G·ª° b·∫£n c≈©..."
if [[ $BTYPE == "chrome" ]]; then
    sudo apt remove -y google-chrome-stable || true
else
    sudo snap remove firefox || sudo apt remove -y firefox || true
fi

if [[ $BTYPE == "chrome" ]]; then
    echo "üöÄ C√†i Chrome..."
    sudo dpkg -i "$FILE_SELECT"
    sudo apt -f install -y
    sudo apt-mark hold google-chrome-stable
    sudo sed -i 's/^deb/# deb/' /etc/apt/sources.list.d/google-chrome.list 2>/dev/null
    sudo rm -rf /opt/google/chrome/cron/
    sudo mkdir -p /etc/opt/chrome/policies/managed
    cat <<EOF | sudo tee /etc/opt/chrome/policies/managed/disable_update.json >/dev/null
{
  "AutoUpdateCheckPeriodMinutes": 0,
  "DisableAutoUpdateChecksCheckbox": true,
  "MetricsReportingEnabled": false
}
EOF
    sudo chmod -R 000 /opt/google/chrome/cron || true

else
    echo "üöÄ C√†i Firefox..."
    [[ "$FILE_SELECT" == *.tar.* ]] || { echo "‚ùå File kh√¥ng h·ª£p l·ªá."; exit 1; }
    tar -xf "$FILE_SELECT"
    sudo rm -rf /opt/firefox_custom
    sudo mv firefox /opt/firefox_custom
    sudo ln -sf /opt/firefox_custom/firefox /usr/local/bin/firefoxcustom
    sudo mkdir -p /opt/firefox_custom/distribution
    cat <<EOF | sudo tee /opt/firefox_custom/distribution/policies.json >/dev/null
{
  "policies": {
    "AppAutoUpdate": false,
    "DisableAppUpdate": true,
    "ManualAppUpdateOnly": true
  }
}
EOF
    sudo mkdir -p /opt/firefox_custom/browser/defaults/preferences
    echo 'pref("app.update.enabled", false);' | sudo tee /opt/firefox_custom/browser/defaults/preferences/disable_update.js >/dev/null
fi

# === T·∫°o shortcut ===
echo "üé® T·∫°o shortcut tr√¨nh duy·ªát..."
mkdir -p ~/.local/share/applications
if [[ $BTYPE == "chrome" ]]; then
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Google Chrome (Custom)
Exec=/usr/bin/google-chrome-stable %U
Icon=google-chrome
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
else
    cat <<EOF > ~/.local/share/applications/browser_custom.desktop
[Desktop Entry]
Name=Firefox (Custom)
Exec=/usr/local/bin/firefoxcustom %U
Icon=/opt/firefox_custom/browser/chrome/icons/default/default128.png
Type=Application
Categories=Network;WebBrowser;
StartupNotify=true
EOF
fi

# === Pin v√†o taskbar theo m√¥i tr∆∞·ªùng ===
DESKTOP_ENV=$(echo "$XDG_CURRENT_DESKTOP" | tr '[:upper:]' '[:lower:]')

if [[ "$DESKTOP_ENV" == *"gnome"* ]]; then
    echo "üìå Ubuntu GNOME - auto pin..."
    gio set ~/.local/share/applications/browser_custom.desktop metadata::trusted true 2>/dev/null
    current_apps=$(gsettings get org.gnome.shell favorite-apps)
    if [[ $current_apps != *"browser_custom.desktop"* ]]; then
        new_apps="${current_apps%]*}, 'browser_custom.desktop']"
        gsettings set org.gnome.shell favorite-apps "$new_apps"
    fi

elif [[ "$DESKTOP_ENV" == *"lxqt"* ]]; then
    echo "üìå Lubuntu LXQt - auto s·ª≠a panel.conf..."
    CONFIG="$HOME/.config/lxqt/panel.conf"
    if [[ -f "$CONFIG" ]] && ! grep -q "browser_custom.desktop" "$CONFIG"; then
        sed -i "/^\[quicklaunch\]/,/^\[/ s|^apps=.*|&,'browser_custom.desktop'|" "$CONFIG"
        echo "‚úÖ ƒê√£ th√™m v√†o quicklaunch. Vui l√≤ng ch·∫°y: lxqt-panel --restart"
    else
        echo "‚ö†Ô∏è Kh√¥ng t·ª± ƒë·ªông ƒë∆∞·ª£c. H√£y k√©o shortcut ra panel th·ªß c√¥ng n·∫øu c·∫ßn."
    fi
else
    echo "‚ö†Ô∏è Kh√¥ng r√µ m√¥i tr∆∞·ªùng desktop. Pin th·ªß c√¥ng."
fi

# =========================
# PH·∫¶N 2: C√ÄI NEKOBOX
# =========================
echo "üì¶ B·∫Øt ƒë·∫ßu c√†i Nekobox..."

sudo add-apt-repository universe -y || true
sudo apt update && sudo apt upgrade -y
sudo apt install -y open-vm-tools open-vm-tools-desktop python3-pip unzip build-essential qtbase5-dev python3-venv

source ~/gdown-venv/bin/activate
pip install --upgrade gdown

echo "üìÇ Chu·∫©n b·ªã th∆∞ m·ª•c Nekobox..."
rm -rf ~/Downloads/nekoray
mkdir -p ~/Downloads/nekoray
cd ~/Downloads

gdown --id "1ZnubkMQL06AWZoqaHzRHtJTEtBXZ8Pdj" -O nekobox.zip || { echo "‚ùå T·∫£i th·∫•t b·∫°i."; exit 1; }
unzip -o nekobox.zip -d ~/Downloads/nekoray

inner_dir=$(find ~/Downloads/nekoray -mindepth 1 -maxdepth 1 -type d | head -n 1)
if [ "$inner_dir" != "" ] && [ "$inner_dir" != "$HOME/Downloads/nekoray" ]; then
    mv "$inner_dir"/* ~/Downloads/nekoray/
    rm -rf "$inner_dir"
fi
cd ~/Downloads/nekoray && chmod +x launcher nekobox nekobox_core || true

echo "üñ•Ô∏è T·∫°o shortcut Nekobox..."
cat <<EOF > ~/Desktop/nekoray.desktop
[Desktop Entry]
Version=1.0
Name=Nekobox
Comment=Open Nekobox
Exec=$HOME/Downloads/nekoray/nekobox
Icon=$HOME/Downloads/nekoray/nekobox.png
Terminal=false
Type=Application
Categories=Utility;
EOF
chmod +x ~/Desktop/nekoray.desktop

mkdir -p ~/.config/autostart
cp ~/Desktop/nekoray.desktop ~/.config/autostart/nekoray.desktop

if [[ "$DESKTOP_ENV" == *"gnome"* ]]; then
    echo "üìå Ubuntu GNOME - auto pin Nekobox..."
    gio set ~/Desktop/nekoray.desktop metadata::trusted true 2>/dev/null
    current_apps=$(gsettings get org.gnome.shell favorite-apps)
    if [[ $current_apps != *"nekoray.desktop"* ]]; then
        new_apps="${current_apps%]*}, 'nekoray.desktop']"
        gsettings set org.gnome.shell favorite-apps "$new_apps"
    fi

elif [[ "$DESKTOP_ENV" == *"lxqt"* ]]; then
    echo "üìå Lubuntu LXQt - th√™m v√†o quicklaunch..."
    CONFIG="$HOME/.config/lxqt/panel.conf"
    if [[ -f "$CONFIG" ]] && ! grep -q "nekoray.desktop" "$CONFIG"; then
        sed -i "/^\[quicklaunch\]/,/^\[/ s|^apps=.*|&,'nekoray.desktop'|" "$CONFIG"
        echo "‚úÖ ƒê√£ th√™m v√†o quicklaunch. Ch·∫°y: lxqt-panel --restart"
    fi
fi

echo "üéâ Ho√†n t·∫•t c√†i ƒë·∫∑t Chrome/Firefox + Nekobox!"
